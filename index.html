<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Jump & Vanish</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: Arial, sans-serif; touch-action: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* UI Overlay für Score */
        #ui {
            position: absolute; top: 20px; left: 20px; color: white; 
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }

        /* Mobile Controls (nur sichtbar auf Touch-Geräten oder kleinen Screens) */
        #controls {
            position: absolute; bottom: 20px; width: 100%; height: 150px;
            display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            pointer-events: none; /* Klicks gehen durch, Buttons fangen sie ab */
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid white; border-radius: 50%;
            width: 80px; height: 80px;
            pointer-events: auto; /* Buttons klickbar machen */
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; user-select: none; -webkit-user-select: none;
        }

        .d-pad { display: flex; gap: 20px; }
        
        /* Game Over Screen */
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        button.restart {
            padding: 15px 30px; font-size: 20px; background: #ff4757; color: white;
            border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="ui">Höhe: <span id="score">0</span>m</div>
    
    <div id="game-over">
        <h1>Gefallen!</h1>
        <p>Deine erreichte Höhe: <span id="final-score">0</span>m</p>
        <button class="restart" onclick="engine.resetGame()">Neu Starten</button>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="btn" id="btn-left">⬅️</div>
            <div class="btn" id="btn-right">➡️</div>
        </div>
        <div class="btn" id="btn-jump">Jump</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- EIGENE GAME ENGINE KLASSE ---
        class GameEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(this.renderer.domElement);

                // Licht
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(10, 20, 10);
                this.scene.add(dirLight);

                // Spielvariablen
                this.platforms = [];
                this.player = null;
                this.keys = { left: false, right: false, jump: false };
                this.gravity = -0.015;
                this.gameOver = false;
                this.score = 0;
                this.highestY = 0;

                this.initPlayer();
                this.initLevel();
                this.setupInputs();
                this.animate();
            }

            initPlayer() {
                const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
                const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 }); // Spieler ist Grün
                this.player = new THREE.Mesh(geometry, material);
                
                // Physics Eigenschaften
                this.player.velocity = { x: 0, y: 0, z: 0 };
                this.player.onGround = false;
                
                this.player.position.y = 1;
                this.scene.add(this.player);
            }

            initLevel() {
                // Start Boden
                this.createPlatform(0, -1, 0, 10, 1, 10, false);

                // Prozedurale Plattformen
                for (let i = 1; i < 50; i++) {
                    this.spawnRandomPlatform(i * 2.5);
                }
            }

            spawnRandomPlatform(yHeight) {
                const x = (Math.random() * 10) - 5; // Zufall X zwischen -5 und 5
                const width = 2 + Math.random() * 1.5;
                this.createPlatform(x, yHeight, 0, width, 0.5, 3, true);
            }

            createPlatform(x, y, z, w, h, d, canVanish) {
                const geometry = new THREE.BoxGeometry(w, h, d);
                const material = new THREE.MeshLambertMaterial({ color: 0x666666 }); // Grau
                const platform = new THREE.Mesh(geometry, material);
                platform.position.set(x, y, z);
                
                // Custom Properties für unsere Engine
                platform.canVanish = canVanish;
                platform.isTouched = false;
                platform.boundingBox = new THREE.Box3().setFromObject(platform);

                this.scene.add(platform);
                this.platforms.push(platform);
            }

            setupInputs() {
                // Keyboard
                window.addEventListener('keydown', (e) => {
                    if (e.code === 'ArrowLeft' || e.code === 'KeyA') this.keys.left = true;
                    if (e.code === 'ArrowRight' || e.code === 'KeyD') this.keys.right = true;
                    if (e.code === 'Space' || e.code === 'ArrowUp') this.keys.jump = true;
                });
                window.addEventListener('keyup', (e) => {
                    if (e.code === 'ArrowLeft' || e.code === 'KeyA') this.keys.left = false;
                    if (e.code === 'ArrowRight' || e.code === 'KeyD') this.keys.right = false;
                    if (e.code === 'Space' || e.code === 'ArrowUp') this.keys.jump = false;
                });

                // Touch Buttons (iPad)
                const addTouch = (id, key) => {
                    const el = document.getElementById(id);
                    el.addEventListener('touchstart', (e) => { e.preventDefault(); this.keys[key] = true; });
                    el.addEventListener('touchend', (e) => { e.preventDefault(); this.keys[key] = false; });
                    el.addEventListener('mousedown', (e) => { this.keys[key] = true; });
                    el.addEventListener('mouseup', (e) => { this.keys[key] = false; });
                };
                addTouch('btn-left', 'left');
                addTouch('btn-right', 'right');
                addTouch('btn-jump', 'jump');

                // Resize Handler
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            checkCollisions() {
                // Spieler BoundingBox aktualisieren
                const playerBox = new THREE.Box3().setFromObject(this.player);
                
                // Wir machen die Box unten etwas kleiner, damit Kollision nur passiert wenn wir drauf fallen
                const feetBox = new THREE.Box3(
                    new THREE.Vector3(playerBox.min.x + 0.1, playerBox.min.y, playerBox.min.z + 0.1),
                    new THREE.Vector3(playerBox.max.x - 0.1, playerBox.min.y + 0.2, playerBox.max.z - 0.1)
                );

                this.player.onGround = false;

                for (let i = this.platforms.length - 1; i >= 0; i--) {
                    const plat = this.platforms[i];
                    
                    // Einfache AABB Kollision
                    if (feetBox.intersectsBox(plat.boundingBox)) {
                        // Nur kollidieren wenn wir fallen
                        if (this.player.velocity.y <= 0) {
                            this.player.velocity.y = 0;
                            this.player.position.y = plat.position.y + 0.65; // Aufsetzen
                            this.player.onGround = true;

                            // 3 Sekunden Timer Logik
                            if (plat.canVanish && !plat.isTouched) {
                                this.triggerVanish(plat);
                            }
                        }
                    }
                }
            }

            triggerVanish(platform) {
                platform.isTouched = true;
                platform.material.color.setHex(0xff0000); // Farbe auf ROT ändern
                
                // Nach 3 Sekunden entfernen
                setTimeout(() => {
                    this.scene.remove(platform);
                    this.platforms = this.platforms.filter(p => p !== platform);
                }, 3000);
            }

            updatePhysics() {
                if (this.gameOver) return;

                // Horizontal
                if (this.keys.left) this.player.position.x -= 0.15;
                if (this.keys.right) this.player.position.x += 0.15;

                // Springen
                if (this.keys.jump && this.player.onGround) {
                    this.player.velocity.y = 0.4; // Sprungkraft
                    this.player.onGround = false;
                }

                // Schwerkraft
                this.player.velocity.y += this.gravity;
                this.player.position.y += this.player.velocity.y;

                // Kollisionen prüfen
                this.checkCollisions();

                // Kamera verfolgt Spieler (nur nach oben)
                if (this.player.position.y > this.highestY) {
                    this.highestY = this.player.position.y;
                    document.getElementById('score').innerText = Math.floor(this.highestY);
                    
                    // Neue Plattformen generieren wenn wir hoch genug sind
                    if (this.highestY > (this.platforms.length / 2)) { 
                        this.spawnRandomPlatform(this.highestY + 20);
                    }
                }

                // Kamera Smooth Lerp
                const targetY = Math.max(2, this.player.position.y + 2);
                this.camera.position.y += (targetY - this.camera.position.y) * 0.1;
                this.camera.position.x = 0;
                this.camera.position.z = 10;
                this.camera.lookAt(0, this.camera.position.y - 2, 0);

                // Game Over Bedingung (Runterfallen)
                if (this.player.position.y < this.camera.position.y - 10) {
                    this.endGame();
                }
            }

            endGame() {
                this.gameOver = true;
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('final-score').innerText = Math.floor(this.highestY);
            }

            resetGame() {
                // Alles zurücksetzen
                this.platforms.forEach(p => this.scene.remove(p));
                this.platforms = [];
                this.player.position.set(0, 1, 0);
                this.player.velocity.y = 0;
                this.highestY = 0;
                this.score = 0;
                this.gameOver = false;
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('score').innerText = '0';
                this.camera.position.set(0, 2, 10);
                
                this.initLevel();
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.updatePhysics();
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Spiel starten
        window.engine = new GameEngine();
    </script>
</body>
</html>
